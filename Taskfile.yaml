version: "3"

vars:
  MAVEN_OPTS: >
    --enable-native-access=ALL-UNNAMED
    --add-opens=java.base/java.lang=ALL-UNNAMED
    --add-opens=java.base/jdk.internal.misc=ALL-UNNAMED
    -XX:+IgnoreUnrecognizedVMOptions

tasks:
  clean:
    desc: Clean target and python resources
    silent: true
    cmds:
      - echo "ðŸ§¹ Cleaning project..."
      - rm -rf python-resources target
      - echo "ðŸ§© Running Maven clean..."
      - MAVEN_OPTS="{{.MAVEN_OPTS}}" ./mvnw clean -q 2>/dev/null
      - echo "âœ… Clean complete."

  build:
    silent: true
    vars:
      MODULE: '{{.MODULE | default ""}}'
      SKIP_TESTS: '{{.SKIP_TESTS | default "false"}}'
    cmds:
      - echo "ðŸ”§ Building {{if .MODULE}}{{.MODULE}}{{else}}project{{end}} ..."
      - |
        export MODULE="{{.MODULE}}"
        export SKIP_TESTS="{{.SKIP_TESTS}}"
        chmod +x scripts/build.sh
        ./scripts/build.sh
      - echo "ðŸ“¦ Build complete"

  test:
    desc: Run tests
    silent: true
    cmds:
      - echo "ðŸ§ª Running tests..."
      - MAVEN_OPTS="{{.MAVEN_OPTS}}" ./mvnw test -q
      - echo "âœ… Tests done."

  verify:
    desc: Run tests and Checkstyle
    silent: true
    cmds:
      - echo "ðŸ” Running tests + Checkstyle..."
      - task: test
      - MAVEN_OPTS="{{.MAVEN_OPTS}}" ./mvnw checkstyle:check -q
      - echo "âœ… Verification complete."

  release:
    desc: Release project (version bump, changelog, tag, deploy)
    silent: true
    vars:
      VERSION: { sh: 'echo ${VERSION:-}' }
      MODULE: { sh: 'echo ${MODULE:-}' }
    cmds:
      - |
        if [ -z "{{.VERSION}}" ]; then
          echo "âŒ VERSION is required"
          echo "Usage:"
          echo "  task release VERSION=0.0.22"
          echo "  task release VERSION=0.0.22 MODULE=polyglot-core"
          exit 1
        fi
  
        echo "ðŸš€ Releasing version {{.VERSION}}"
        
        if [ -n "{{.MODULE}}" ]; then
          echo "ðŸ“¦ Target module: {{.MODULE}}"
        else
          echo "ðŸ“¦ Target: ALL modules"
        fi
  
        chmod +x ./scripts/release.sh
        ./scripts/release.sh {{.VERSION}} {{.MODULE}}
  
        echo "âœ… Release {{.VERSION}} completed"


  bump:
    desc: Bump project version (patch|minor|major)
    silent: true
    vars:
      TYPE: { sh: 'echo ${TYPE:-patch}' }
    cmds:
      - echo "â¬†ï¸  Bumping {{.TYPE}} version..."
      - chmod +x ./scripts/bump.sh
      - ./scripts/bump.sh {{.TYPE}}
      - echo "âœ… Version bumped."

  clean-remote-tags:
    desc: Delete remote tags that don't exist locally
    silent: true
    cmds:
      - echo "ðŸ§¨ Cleaning remote tags..."
      - chmod +x ./scripts/clean-remote-tags.sh
      - ./scripts/clean-remote-tags.sh
      - echo "âœ… Remote tags cleaned."

  version:
    desc: Show current project version
    silent: true
    cmds:
      - echo "ðŸ“¦ Current version:"
      - ./mvnw -q help:evaluate -Dexpression=project.version -DforceStdout 2>/dev/null | tr -d '\r' | grep -E '^[0-9]'

  format:
    desc: Format code with Spotless
    cmds:
      - ./mvnw spotless:apply

  default:
    desc: Default task (clean + build)
    silent: false
    cmds:
      - task: clean
      - task: build

