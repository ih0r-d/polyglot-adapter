name: ğŸš€ Maven Central Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.ref_name }}

      - name: â˜• Setup JDK 25 (Temurin)
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 25
          cache: maven

      - name: ğŸ§ª Run tests with coverage check (min 75%)
        run: |
          mvn clean verify org.jacoco:jacoco-maven-plugin:prepare-agent org.jacoco:jacoco-maven-plugin:report
          COVERED=$(grep -A 1 '<counter type="INSTRUCTION"' target/site/jacoco/jacoco.xml | grep -oP 'covered="\K[0-9]+' | awk '{s+=$1} END{print s}')
          MISSED=$(grep -A 1 '<counter type="INSTRUCTION"' target/site/jacoco/jacoco.xml | grep -oP 'missed="\K[0-9]+' | awk '{s+=$1} END{print s}')
          TOTAL=$((COVERED + MISSED))
          if [ "$TOTAL" -eq 0 ]; then
            echo "âŒ No coverage data found!"
            exit 1
          fi
          PERCENT=$((100 * COVERED / TOTAL))
          echo "â¡ï¸ Code Coverage: ${PERCENT}%"
          if [ "$PERCENT" -lt 75 ]; then
            echo "âŒ Coverage below 75%! (${PERCENT}%)"
            exit 1
          fi

      - name: ğŸ§¾ Configure Maven Central credentials
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>central</id>
                <username>${{ secrets.MAVEN_USERNAME }}</username>
                <password>${{ secrets.MAVEN_PASSWORD }}</password>
              </server>
            </servers>
          </settings>
          EOF
          echo "âœ… ~/.m2/settings.xml created"

      - name: â˜ï¸ Deploy to Maven Central
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mvn -s settings.xml clean deploy -P release -Dgpg.skip=false -Denv.GPG_PASSPHRASE="${GPG_PASSPHRASE}"

      - name: ğŸ·ï¸ Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ğŸš€ **Maven Central release**
            âœ… Tests passed (â‰¥75% coverage)
            â˜ï¸ Successfully deployed to Maven Central
          token: ${{ secrets.GITHUB_TOKEN }}
